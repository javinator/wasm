<!DOCTYPE html>
<html>
<head>
<title>JS Parser and Wasm Player</title>
<meta charset="UTF-8">
<script src="resources/compiler.js"></script>
<script src="resources/parser.js"></script>
<script>
function write(input) {
    memlen = 0;
    memarr = [];
    stringarr = [];
    stringmem = [];
    stringflag = 0;
    var root = Parser.parse(input);
    var textToWrite = visit.visitModule(root);
    var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
    var fileNameToSaveAs = "index.wat";
    var downloadLink = document.createElement("a");
    downloadLink.download = fileNameToSaveAs;
    downloadLink.innerHTML = "Download File";
    if (window.webkitURL != null)
    {
        // Chrome allows the link to be clicked
        // without actually adding it to the DOM.
        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
    }
    else
    {
        // Firefox requires the link to be added to the DOM
        // before it can be clicked.
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
    }
    
    console.log(textToWrite);
    console.log("The above has been written to file 'index.wat'");

    downloadLink.click();
}
</script>
</head>
<body align="center">
<table width="90%">
<tr><td width="50%">
 <form action="javascript:write(document.getElementById('code').value)">
  Write your code below:<br><br>
   <textarea id="code" name="message" rows="20" cols="50" style="padding: 5px;">
def main {
call fac(6);
};
 
def fac(x) {
if (x&lt;1) {
x=1;
} else {
x = x*call fac(x-1);
};
x;
};
</textarea> <br>
  <input type="submit" value="Submit" style="margin: 10px;">
  </form> 
</td><td width="50%">
The result of the loaded Webassembly function is:<br>
<p id="result"></p>
<form action="javascript:updateResult()">
  <input type="submit" value="Display result" style="margin: 10px;">
  </form>
</tr></td></table>
<script>
function utf8ToString(h, p) {
  let s = "";
  for (i = p; h[i]; i++) {
    s += String.fromCharCode(h[i]);
  }
  return s;
}

function updateResult() {
var importObject = {
  imports: { imported_func: arg => console.log(arg) }
};

fetch('index.wasm').then(response =>
  response.arrayBuffer()
).then(bytes =>
  WebAssembly.instantiate(bytes, importObject)
).then(obj => {
  	// Call an exported function:
  	let h = new Uint8Array(obj.instance.exports.memory.buffer);
	let p = obj.instance.exports.main();
	if (stringflag > 0) {
		document.getElementById("result").innerHTML = utf8ToString(h, p);
	}
	else { document.getElementById("result").innerHTML = p;
	}
})
}
</script>
</body>
</html>
